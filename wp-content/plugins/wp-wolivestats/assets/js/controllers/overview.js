angular.module("Wolive").controller("OverviewController",["$scope","$rootScope","$timeout","ajaxAdmin","Functions","moment",function(e,t,a,o,i,s){function n(e){return function(t,a){return t[e]>a[e]?1:t[e]<a[e]?-1:0}}function r(e,t,a){for(var o=[],i=[],s=0;s<e.length;s++)o.push({x:parseInt(e[s].x),y:parseInt(e[s].y)});for(var s=0;s<t.length;s++)i.push({x:parseInt(t[s].x),y:parseInt(t[s].y)});o.sort(n("x")),i.sort(n("x"));var r=[{values:o,key:"Actions",color:"#ff7f0e"},{values:i,key:"Visits",color:"#7777ff"}];u?f.datum(r).transition().duration(500).call(u):nv.addGraph(function(){return u=nv.models.lineChart().margin({left:20,top:30,right:20}).useInteractiveGuideline(!0).duration(350).showLegend(!1).showYAxis(!1).showXAxis(!0).forceX([0,a]).forceY([0,1]).interpolate(!0),f=d3.select(".graphVisits svg").datum(r),f.transition().duration(500).call(u),u})}function l(e){if(!wolive.windowFocus)return!1;angular.forEach(e,function(t,a){e[a].value=parseInt(e[a].value)});var t=e;if(p)try{0===e.length?(p.color(["rgba(93,196,219,0.4)"]),t=[{label:"No users online",value:.1}],jQuery(".graphLiveUser  .nv-pieLabels").hide()):(jQuery(".graphLiveUser .nv-pieLabels").show(),p.color(["#4da0ff","#ffac4d","#4dffe7","#ffe74d","#ff4d56"])),d.datum(t).transition().duration(350).call(p)}catch(e){}else nv.addGraph(function(){return p=nv.models.pieChart().x(function(e){return e.label}).y(function(e){return e.value}).labelThreshold(1).labelType("percent").showLegend(!0).showLabels(!0).labelThreshold(1).donut(!0).color(["#4da0ff","#ffac4d"]).noData("No data"),p.valueFormat(d3.format("d")),0===e.length?(p.color(["rgba(93,196,219,.4)"]),t=[{label:"No users online",value:1e-4}]):p.color(["#4da0ff","#ffac4d","#4dffe7","#ffe74d","#ff4d56"]),d=d3.select(".graphLiveUser svg").datum(t),d.transition().duration(350).call(p),0===e.length&&jQuery(".graphLiveUser  .nv-pieLabels").hide(),p})}var c=this;c.popular_pages=[],c.popular_search=[],c.popular_referers=[],c.today_popular_products=[],c.cart_live=[],c.time_average=0,c.map=[],c.getIconBrow=i.classBrowser,c.getSO=i.classSO,e.go=i.goBlank,e.isFocus=!0,e.goUser=i.goUser,c.itemScopes=[{name:"Online Visitors",step:1,method:"getOnline",count:0,update:function(e){e=e.data,c.online_visitors_from=c.online_visitors?c.online_visitors:0,c.online_visitors=e.online.users,0==c.online_visitors_from&&c.online_visitors>0&&wolive.audioClick.play()}},{name:"Map",step:3,method:"getUserData",count:0,update:function(e){e=e.data,c.setCircles(e.online_users)}},{name:"Total Visits",step:7,method:"getVisits",count:0,update:function(e){e=e.data,c.today_visits_from=c.today_visits?c.today_visits:0,c.today_visits=e.total_visits.total,c.today_actions_from=c.today_actions?c.today_actions:0,c.today_actions=e.total_actions.total,c.time_average_from=c.time_average?c.time_average:0,c.time_average=e.time_average,c.today_action_visit_from=c.today_action_visit?c.today_action_visit:0,c.today_visits>0?c.today_action_visit=c.today_actions/c.today_visits:c.today_action_visit=0}},{name:"Graph Today",step:18,method:"getGraphToday",count:0,update:function(e){e=e.data,c.actions_hour=e.actions_hour,c.visits_hour=e.visits_hour,r(c.actions_hour,c.visits_hour,e.HOUR)}},{name:"Last Users",step:5,method:"getLastUsers",count:0,update:function(e){e=e.data,c.last_users=c.diffTimezoneUsers(e.last_users)}},{name:"Live Pages",step:4,method:"getLivePages",count:0,update:function(e){e=e.data,c.updateArrayID("popular_pages",e.popular_pages),c.updateArrayID("popular_referers",e.popular_referers)}},{name:"GraphUserType",step:1,method:"getGraphUserType",count:0,update:function(e){e=e.data,l(e.user_type)}}],e.$on("$viewContentLoaded",function(){wolive.resize(),c.reloadOverview(),i.setFocusEvents(function(t){e.isFocus=t})}),e.$on("$destroy",function(){a.cancel(e.timer_scope)}),c.reloadOverview=function(){var t={action:"getOverview"};o.newRequest(t,function(t){var o=t.data;c.online_visitors_from=c.online_visitors?c.online_visitors:0,c.online_visitors=o.online.users,c.today_visits_from=c.today_visits?c.today_visits:0,c.today_visits=o.total_visits.total,c.today_actions_from=c.today_actions?c.today_actions:0,c.today_actions=o.total_actions.total,c.today_action_visit_from=c.today_action_visit?c.today_action_visit:0,c.today_visits>0?c.today_action_visit=c.today_actions/c.today_visits:c.today_action_visit=0,c.time_average_from=c.time_average?c.time_average:0,c.time_average=o.time_average,c.actions_hour=o.actions_hour,c.visits_hour=o.visits_hour,r(c.actions_hour,c.visits_hour,o.HOUR),c.last_users=c.diffTimezoneUsers(o.last_users),c.last_action2=new Date,c.updateArrayID("popular_pages",o.popular_pages),c.updateArrayID("popular_referers",o.popular_referers),l(o.user_type),e.timestamp=o.timestamp,e.timer_scope=a(c.scopeTimer,wolive_scoopeTime),wolive.resize(),$("#center-overview-middle").fadeIn(100,function(){c.setMap(),c.setCircles(o.online_users)})})},c.scopeTimer=function(){for(var t=c.itemScopes,i=0;i<c.itemScopes.length;i++){var s=t[i];if(++s.count>=s.step){s.count=0;var n={action:"getScopeTime",method:s.method,ignoreLoadingBar:!0};o.newRequest(n,t[i].update)}}e.timer_scope=a(c.scopeTimer,wolive_scoopeTime)},c.processActions=function(e){angular.forEach(e,function(e,t){c.actionIsPage(e.action_type)&&angular.forEach(c.popular_pages,function(t,a){t.id==e.value_int&&(t.total=parseInt(t.total)+1)}),"hit_src"==e.action_type&&angular.forEach(c.popular_search,function(t,a){t.id==e.value_int&&(t.total=parseInt(t.total)+1)})})},c.actionIsPage=function(e){return"hit_url"==e||"hit_post"==e||"hit_index"==e||"hit_src"==e},c.updateArrayID=function(e,t){var a=!1;if(0==c[e].length)return c[e]=t,0!=t.length;for(var o=c[e].length-1;o>=0;o--){var i=!1;objold=c[e][o],angular.forEach(t,function(e,t){e.id==objold.id&&e.action_type==objold.action_type&&(i=!0)}),i||(c[e].splice(o,1),a=!0)}return angular.forEach(t,function(t,o){var i=!1;angular.forEach(c[e],function(e,o){t.id==e.id&&t.action_type==e.action_type&&(e.total!=t.total&&(a=!0),e.total=parseInt(t.total),e.percent=parseInt(t.percent),i=!0)}),i||(c[e].push(t),a=!0)}),a},c.diffTimezoneUsers=function(e){return angular.forEach(e,function(t,a){e[a].last_action=(Date.now()/1e3|0)-e[a].timestamp_diff}),e};var u,f,p,d;c.setMap=function(){var e={zoom:0,zoomControl:!1,scrollwheel:!1,disableDoubleClickZoom:!0,disableDefaultUI:!0,center:new google.maps.LatLng(0,0),draggable:!1,styles:[{featureType:"poi",elementType:"all",stylers:[{hue:"#000000"},{saturation:-100},{lightness:-100},{visibility:"off"}]},{featureType:"poi",elementType:"all",stylers:[{hue:"#000000"},{saturation:-100},{lightness:-100},{visibility:"off"}]},{featureType:"administrative",elementType:"all",stylers:[{hue:"#000000"},{saturation:0},{lightness:-100},{visibility:"off"}]},{featureType:"road",elementType:"labels",stylers:[{hue:"#ffffff"},{saturation:-100},{lightness:100},{visibility:"off"}]},{featureType:"water",elementType:"labels",stylers:[{hue:"#000000"},{saturation:-100},{lightness:-100},{visibility:"off"}]},{featureType:"road.local",elementType:"all",stylers:[{hue:"#ffffff"},{saturation:-100},{lightness:100},{visibility:"on"}]},{featureType:"water",elementType:"geometry",stylers:[{hue:"#ffffff"},{saturation:-100},{lightness:100},{visibility:"on"}]},{featureType:"transit",elementType:"labels",stylers:[{hue:"#000000"},{saturation:0},{lightness:-100},{visibility:"off"}]},{featureType:"landscape",elementType:"labels",stylers:[{hue:"#000000"},{saturation:-100},{lightness:-100},{visibility:"off"}]},{featureType:"road",elementType:"geometry",stylers:[{hue:"#bbbbbb"},{saturation:-100},{lightness:26},{visibility:"on"}]},{featureType:"landscape",elementType:"geometry",stylers:[{hue:"#dddddd"},{saturation:-100},{lightness:-3},{visibility:"on"}]}]},t=document.getElementById("liveMap");c.map=new google.maps.Map(t,e)},c.circlesMap=[],c.setCircles=function(e){geocoder=new google.maps.Geocoder;for(var t=0;t<c.circlesMap.length;t++)c.circlesMap[t].setMap(null);c.circlesMap=[],angular.forEach(e,function(e,t){geocoder.geocode({address:e.country},function(e,t){if(t==google.maps.GeocoderStatus.OK){var a=new google.maps.Circle({strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:.2,fillColor:"#FF0000",fillOpacity:.25,map:c.map,center:e[0].geometry.location,radius:5e5});c.circlesMap.push(a)}})})},e.getTypeReferer=function(e){return String.prototype.contains=function(e){return-1!=this.indexOf(e)},e.contains("facebook.com")?"fa fa-facebook-official":e.contains("pinterest.com")?"fa fa-pinterest":e.contains("twitter.com")?"fa fa-twitter":e.contains("youtube.com")?"fa fa-youtube-play":e.contains("linkedin.com")?"fa fa-linkedin-square":e.contains("google.com")?"fa fa-google":e.contains("yahoo.com")?"fa fa-yahoo":e.contains("wikipedia.com")?"fa fa-wikipedia-w":e.contains("instagram.com")?"fa fa-instagram":"fa fa-tag"},c.feedBack=function(){var e={action:"getfeedBack"};o.newRequest(e,function(e){if(1==e.data.code)return!0;e.data.status<1&&i.go(url_options)})},c.feedBack()}]);