angular.module("Wolive").controller("Reports",["$location","$scope","$rootScope","$timeout","ajaxAdmin","Functions","$rootScope","$uibModal",function(e,t,r,a,o,n,r,s){var i=this;t.woocommerce=woocommerce_wl,t.typeStatus=!1,t.template_custom=wolive_assets_url+"js/templates/custom.html",t.name_report="visits",t.$on("$viewContentLoaded",function(){n.setFocusEvents(function(e){t.isFocus=e}),i.resizeTemplate(),$(window).resize(i.resizeTemplate),t.filter_date="today"}),t.$on("$destroy",function(){$(window).off("resize",i.resizeTemplate),a.cancel(t.timer_scope)}),i.resizeTemplate=function(){},t.$watch("[filter_date,name]",function(){i.createChart()},!0),t.changeDateFilter=function(e){t.filter_date=e},t.goToReport=function(e){t.name_report=e,d3.select("svg").selectAll("*").remove(),d3.selectAll(".nvtooltip").remove(),i.createChart()},t.refresh=function(){i.createChart()},i.createChart=function(){var e=i.reports[t.name_report];t.table=[],t.type=e.type,t.titleReport=e.name;var r={action:"getReport",report_type:t.name_report,report_date:t.filter_date};"range"==t.filter_date&&(r.range=t.range);o.newRequest(r,e.create.bind(this))};var c;i.open=function(e,r){var a=r?angular.element($document[0].querySelector(".modal-demo "+r)):void 0;c=s.open({animation:!0,ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body",templateUrl:"myModalContent.html",controller:"customDate",controllerAs:"$ctrl",appendTo:a,resolve:{items:function(){}}}),c.result.then(function(e){t.range=e,"range"!=t.filter_date?t.filter_date="range":i.createChart()},function(){})},i.reports={visits:{name:"Visits & Actions",method:"reportVisits",type:"line",create:function(e){d3.selectAll(".nvtooltip").remove();var r=e.data,a=[],o=[];if(t.table_type=r.filter.type,t.table=r.table,"today"==t.table_type||"yesterday"==t.table_type||"day"==t.table_type){i.table=[];for(var n=0;n<r.actions.length;n++)a.push({x:parseInt(r.actions[n].x),y:parseInt(r.actions[n].y)});for(var n=0;n<r.visits.length;n++)o.push({x:parseInt(r.visits[n].x),y:parseInt(r.visits[n].y)})}else{for(var n=0;n<r.actions.length;n++)a.push({x:parseInt(r.actions[n].x),y:parseInt(r.actions[n].y)});if(r.visits)for(var n=0;n<r.visits.length;n++)o.push({x:parseInt(r.visits[n].x),y:parseInt(r.visits[n].y)})}a.sort(keysrt("x")),o.sort(keysrt("x"));var s=[{values:a,key:"Actions",color:"#ff7f0e"},{values:o,key:"Visits",color:"#7777ff"}];nv.addGraph(function(){var e=nv.models.lineChart().useInteractiveGuideline(!0).showLegend(!1).showYAxis(!0).forceY([0,1]).showXAxis(!0).margin({left:30,top:30,right:20}).duration(350).interpolate(!0);return"today"==t.filter_date||"yesterday"==t.filter_date||"day"==t.table_type?e.forceX([0,23]):(e.xAxis.ticks(4),e.xAxis.tickFormat(function(e){return d3.time.format("%m.%d.%Y")(new Date(1e3*e))})),e.yAxis.tickFormat(d3.format("s")),d3.select("#chartReport svg").datum(s).call(e),e})}},search:{name:"Search",method:"getSearch",type:"bar",create:function(e){i.barType(e)}},post:{name:"Post",method:"getPost",type:"bar",create:function(e){i.barType(e)}},url:{name:"URL",method:"getURL",type:"bar",create:function(e){i.barType(e)}},countries:{name:"Countries",method:"getCountries",type:"bar",create:function(e){i.barType(e)}},platforms:{name:"Platforms",method:"getCountries",type:"bar",create:function(e){i.barType(e)}},browsers:{name:"Browsers",method:"getCountries",type:"bar",create:function(e){i.barType(e)}},languages:{name:"Languages",method:"getCountries",type:"bar",create:function(e){i.barType(e)}},screens:{name:"Screens",method:"getCountries",type:"bar",create:function(e){i.barType(e)}},referers:{name:"Referers/Sources",method:"getCountries",type:"bar",create:function(e){i.barType(e)}},addtocart:{name:"Added to cart products",method:"getCart",type:"bar",create:function(e){i.barType(e)}},removecart:{name:"Removed item from cart",method:"getCart",type:"bar",create:function(e){i.barType(e)}},coupons:{name:"Coupons",method:"getCart",type:"bar",create:function(e){i.barType(e)}}},t.getColorBar=function(e){return d3.scale.category20().range()[e]},i.barType=function(e){var r=e.data;d3.selectAll(".nvtooltip").remove(),d3.select("svg").selectAll("*").remove(),t.table_type=r.filter.type,t.table=r.rows,nv.addGraph(function(){var e=nv.models.discreteBarChart().x(function(e){return e.label}).y(function(e){return e.value}).staggerLabels(!1).showValues(!1).duration(350).forceY([0,5]).showXAxis(!1).margin({left:30,top:30,right:20}),t=r.rows.slice(0,20);angular.forEach(t,function(e,r){t[r].value=parseInt(t[r].value)});var a=[{key:"",values:t}];return e.yAxis.tickFormat(d3.format("s")),d3.select("#chartReport svg").datum(a).call(e),e})}}]);